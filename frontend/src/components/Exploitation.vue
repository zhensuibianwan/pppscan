<template>
    <dev style="display: flex; margin-top: 5%;margin-left: 8%">
    <el-button  size="large" :icon="Setting" @click="showAdd=true" type="warning" >设置</el-button>
      <el-col :span="6" style="margin-left: 2%" >
        <el-input v-model="input"  style="width: 180%;margin-left: 2%;"  size="large" @keyup.enter="ExploitationPoc" clearable>
          <template #prepend>input</template>
        </el-input>
      </el-col>
      <el-button  size="large" :icon="Aim" @click="ExploitationPoc" type="danger"  style="margin-left: 23%">执行</el-button>
      <el-upload
          :auto-upload="false"
          :on-change="uploadChange"
          :show-file-list="false"
          style="margin-left: 2%"
      >
        <el-button  size="large" :icon="Upload" type="primary" >导入</el-button>
      </el-upload>
      <el-button  size="large" :icon="RefreshRight" @click="clearInput" type="danger" style="margin-left: 2%" >清空</el-button>
    </dev>
  <el-form :model="ExploitationForm"   label-position="top" style=";margin-left: 8%" class="background">
    <el-form-item label="执行结果"  class="labelSize background"  style="margin-top: 4%" >
      <el-input v-model="ExploitationForm.result" style="width: 92%;border: 2px solid var(--el-border-color);border-radius: 4px;" :rows="21" type="textarea"/>
    </el-form-item>
  </el-form>

  <el-dialog
      v-model="showAdd"
      align-center
      center
      width="80%"
      draggable
      title="选择POC"
  >
    <dev style="display: flex">
    <el-button  size="large" :icon="Star" @click="selectPocShow=true" type="success" style="margin-left: 10%">选择poc</el-button>
    <el-form-item label="url" style="margin-left: 10%" >
      <el-input v-model="ExploitationForm.url" size="large" style="width: 400px" />
    </el-form-item>
    </dev>
    <el-form-item label="URL编码"  style="margin-top: 3%;margin-left: 10%">
      <el-switch v-model="ExploitationForm.encodeEnable" />
    </el-form-item>
<!--

-->

    <div style="margin-left: 67%;margin-top:3%">
      <el-button  size="large" :icon="CloseBold" @click="cancelSetting">取消</el-button>
      <el-button size="large" :icon="Select"  type="primary" @click="sureSetting">确认</el-button>
    </div>
  </el-dialog>

  <el-dialog
      v-model="selectPocShow"
      align-center
      center
      width="80%"
      draggable
      title="选择POC"
  >
    <el-col :span="6" style="margin-left: 3%;">
      <el-input v-model="searchInput"  style="width: 378%; " size="large"  @keyup.enter="pocList()" clearable>
        <template #prepend>漏洞名称</template>
        <template #append><el-button :icon="Search" style="width: 75px;color: #409eff"  @click="pocList"/></template>
      </el-input>
    </el-col>
    <div class="demo-radius2" >
      <el-table
          ref="exploitationPocListRef"
          :data="table.tableData"
          style="width: 100%"
          @selection-change="exploitationSelectionChange"
          height="100%"
      >
        <el-table-column   type="selection" width="35" />
        <el-table-column   label="漏洞名称" width="430">
          <template #default="scope">
            <el-tooltip  placement="top" >
              <template #content>  {{ scope.row.description }} </template>
              {{ scope.row.name }}
            </el-tooltip>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!--    <el-button size="large" :icon="Select"  type="primary" @click="" style="margin-top: 2%; margin-left: 86%">确认</el-button>-->
    <div style="margin-left: 72%;margin-top: 2%">
      <el-button  size="large" :icon="CloseBold" @click="cancelSelectPoc">取消</el-button>
      <el-button size="large" :icon="Select"  type="primary" @click="sureSelectPoc">确认</el-button>
    </div>
  </el-dialog>

</template>

<script lang="ts" setup>
import {Search, Aim,Upload,RefreshRight,Star,Download,Close,CaretRight,Select,CloseBold,Setting} from '@element-plus/icons-vue';
import {reactive, ref} from "vue";
import {LocalList, PocExploitation, PocList} from "../../wailsjs/go/main/App";
import {publicCode} from "../../wailsjs/go/models";
import {ElMessage, ElMessageBox, ElTable} from "element-plus";
import {EventsOn} from "../../wailsjs/runtime";

const searchInput = ref('')

const showAdd = ref(false);

const selectPocShow = ref(false)

const input = ref('')

const ExploitationForm = reactive({
  result: '',
  upload: '',
  url: '',
  encodeEnable: false,
})


const pocSelection = ref<publicCode.Poc[]>([])

const exploitationPocListRef = ref<InstanceType<typeof ElTable>>()

function sureSelectPoc() {
  selectPocShow.value = false
}

function cancelSelectPoc() {
  exploitationPocListRef.value!.clearSelection()
  selectPocShow.value = false
}


function sureSetting() {
  showAdd.value = false
}

function cancelSetting() {
  showAdd.value = false
}

const exploitationSelectionChange = (val: publicCode.Poc[]) => {
  pocSelection.value = val
}



let oldInput = ''
let sr
function ExploitationPoc(){
  if (ExploitationForm.url != 0){
    if(pocSelection.value.length==1){
      let check = 0
     for(let i=0;i<pocSelection.value[0].needData.length;i++){
       if(pocSelection.value[0].needData[i].label.includes('input')){
         if (ExploitationForm.upload == ''){
           if (oldInput == ''){
             oldInput = pocSelection.value[0].needData[i].value
           }
           ExploitationForm.result = ExploitationForm.result + "input的格式：" + oldInput + "\n"
           if (ExploitationForm.encodeEnable == true){
              sr = encodeURIComponent(input.value)
           }else {
             sr = input.value
           }
           pocSelection.value[0].needData[i].value = sr
         }else{
           if (oldInput == ''){
             oldInput = pocSelection.value[0].needData[i].value
           }
           ExploitationForm.result = ExploitationForm.result + "input的格式：" + oldInput + "\n"
           if (ExploitationForm.encodeEnable == true){
             sr = encodeURIComponent(ExploitationForm.upload)
           }else {
             sr = ExploitationForm.upload
           }
           pocSelection.value[0].needData[i].value = sr
         }
         check = 1
       }
     }
      if (check==0){
        ElMessage.error("请选择带input的poc！")
      }else {
        PocExploitation(pocSelection.value[0], ExploitationForm.url)
        ExploitationForm.upload = ''
      }
    }else if (pocSelection.value.length > 1){
      ElMessage.error("只能选择一个poc！")
    }else {
      ElMessage.error("请选择一个poc！")
    }

  }else {
    ElMessage({
      message: '请输入url！',
      type: 'error',
    })
  }

}

EventsOn('ExploitationScan', function (msg){
    ExploitationForm.result = ExploitationForm.result + msg

})



const table = reactive({
  tableData: [] as Array<publicCode.Poc>,
})

async function pocListFile() {
  table.tableData = await LocalList(searchInput.value)
}

async function pocList() {
  table.tableData = await PocList(searchInput.value)
}

function loadingList(){
  pocListFile()
  pocList()
}


loadingList()

const uploadChange = (file) => {
  if (file.raw) {
    const reader = new FileReader()
    reader.onload = () => {
      ExploitationForm.upload = reader.result.toString()
    }
    reader.readAsText(file.raw)
  }
  ElMessage({
    message: '导入成功！',
    type: 'success',
  })
}

function clearInput(){
  ElMessageBox.confirm(
      '确定清空吗？',
      '提示',
      {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning',
      }
  )
      .then(() => {
        ElMessage({
          type: 'success',
          message: '清空成功！',
        })
        setTimeout(function() {
          location.reload();
        }, 800);
      })
      .catch(() => {
      })
}





</script>

<style scoped>

</style>